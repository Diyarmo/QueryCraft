<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>QueryCraft</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pico-css@2.0.6/dist/pico.min.css" />
    <style>
        :root {
            color-scheme: light;
            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.12);
            --bg-muted: #f8fafc;
            --text-dark: #0f172a;
            --text-muted: #5f6b7c;
        }

        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, #e0edff 0%, #f8fbff 45%, #ffffff 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .page {
            max-width: 960px;
            margin: 0 auto;
            padding: 3rem 1.5rem 4rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.75rem;
            margin-bottom: 0.35rem;
        }

        header p {
            color: var(--text-muted);
            margin: 0 auto;
            max-width: 540px;
        }

        main {
            background: #fff;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 70px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        form {
            display: grid;
            gap: 1.5rem;
        }

        label span {
            display: inline-block;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        textarea {
            min-height: 200px;
            width: 100%;
        }

        textarea,
        select,
        input,
        button {
            border-radius: 12px;
        }

        textarea,
        select,
        input {
            border: 1px solid rgba(15, 23, 42, 0.16);
            padding: 0.75rem 0.9rem;
            background: #fff;
            font-size: 1rem;
        }

        textarea:focus,
        select:focus,
        input:focus {
            border-color: var(--accent);
            outline: 2px solid var(--accent-soft);
            box-shadow: 0 0 0 2.5px var(--accent-soft);
        }

        .field-helper {
            display: block;
            margin-top: 0.4rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        button {
            padding: 0.75rem 1.75rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        button.primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
        }

        button.secondary {
            background: rgba(15, 23, 42, 0.08);
            color: var(--text-dark);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
        }

        .hidden { display: none !important; }

        .status {
            margin-top: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 1rem 1.2rem;
            border-radius: 16px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            background: var(--bg-muted);
        }

        .status.info { color: #0c4a6e; border-color: rgba(12, 74, 110, 0.2); background: rgba(12, 74, 110, 0.06); }
        .status.success { color: #166534; border-color: rgba(22, 101, 52, 0.2); background: rgba(22, 101, 52, 0.06); }
        .status.error { color: #b91c1c; border-color: rgba(185, 28, 28, 0.2); background: rgba(185, 28, 28, 0.06); }

        .status .stage-tag {
            background: rgba(15, 23, 42, 0.05);
            border-radius: 999px;
            padding: 0.2rem 0.75rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        section + section {
            margin-top: 2rem;
        }

        .panel {
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 20px;
            padding: 1.5rem;
            background: #fff;
        }

        .panel h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        pre {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 16px;
            padding: 1rem;
            overflow-x: auto;
        }

        .meta-grid {
            display: grid;
            gap: 0.5rem 1rem;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            margin: 0;
        }

        .meta-grid dt {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .meta-grid dd {
            margin: 0 0 0.9rem;
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--text-dark);
        }

        .results-table {
            margin-top: 1rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
        }

        th, td {
            padding: 0.95rem 1rem;
            text-align: left;
            font-size: 0.95rem;
        }

        th {
            background: var(--bg-muted);
            font-weight: 600;
            color: var(--text-muted);
        }

        tr:not(:last-child) td {
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        }

        .muted { color: var(--text-muted); }

        @media (max-width: 640px) {
            .page { padding: 2.5rem 1rem; }
            main { padding: 1.5rem; }
            button { width: 100%; justify-content: center; }
            .form-actions { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <h1>QueryCraft</h1>
            <p>Ask a question about your commerce data and let the agent translate it into safe SQL in seconds.</p>
        </header>
        <main>
        <form id="query-form">
            {% csrf_token %}
            <label>
                <span>Question</span>
                <textarea id="question" name="question" placeholder="e.g. Show the top 5 products by total orders last month" required></textarea>
                <small class="field-helper">Be as specific as possible—include time ranges, customer segments, or aggregation hints.</small>
            </label>
            <label>
                <span>Language</span>
                <select id="language" name="language">
                    <option value="en" selected>English</option>
                    <option value="fa">Persian</option>
                </select>
                <small class="field-helper">We understand English and Persian questions.</small>
            </label>
            <label>
                <span>Max Rows (optional)</span>
                <input id="max_rows" name="max_rows" type="number" min="1" placeholder="Default from backend" />
                <small class="field-helper">Override the default limit if you need more detail (200 max enforced server-side).</small>
            </label>
            <div class="form-actions">
                <button type="submit" id="submit-btn" class="primary">Ask</button>
                <button type="reset" id="reset-btn" class="secondary">Reset</button>
                <button type="button" id="seed-btn" class="secondary">Seed Database</button>
            </div>
            <small class="field-helper">Need fresh demo data? Click “Seed Database” to run the Faker seeding command server-side.</small>
        </form>

        <section id="status" class="status hidden" role="status" aria-live="polite"></section>

        <section id="sql-section" class="panel hidden">
            <h2>Generated SQL</h2>
            <pre id="sql-output"></pre>
        </section>

        <section id="meta-section" class="panel hidden">
            <h2>Query Details</h2>
            <dl class="meta-grid">
                <dt>Rows Returned</dt>
                <dd id="row-count">0</dd>
                <dt>Execution Time</dt>
                <dd id="execution-time">&mdash;</dd>
                <dt>Row Limit</dt>
                <dd id="row-limit">Default</dd>
            </dl>
        </section>

        <section id="results-section" class="panel hidden">
            <h2>Results</h2>
            <p class="muted" id="results-empty">Run a query to see results here.</p>
            <div class="results-table hidden" id="results-wrapper">
                <table id="results-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        </main>
    </div>

    <script>
        const form = document.getElementById('query-form');
        const questionInput = document.getElementById('question');
        const languageSelect = document.getElementById('language');
        const maxRowsInput = document.getElementById('max_rows');
        const statusEl = document.getElementById('status');
        const submitBtn = document.getElementById('submit-btn');
        const defaultSubmitLabel = submitBtn.textContent;
        const seedBtn = document.getElementById('seed-btn');
        const defaultSeedLabel = seedBtn ? seedBtn.textContent : '';
        const sqlSection = document.getElementById('sql-section');
        const sqlOutput = document.getElementById('sql-output');
        const metaSection = document.getElementById('meta-section');
        const rowCountEl = document.getElementById('row-count');
        const executionTimeEl = document.getElementById('execution-time');
        const rowLimitEl = document.getElementById('row-limit');
        const resultsSection = document.getElementById('results-section');
        const resultsWrapper = document.getElementById('results-wrapper');
        const resultsEmpty = document.getElementById('results-empty');
        const resultsTable = document.getElementById('results-table');

        function formatStageLabel(stage) {
            if (!stage) {
                return '';
            }
            return stage
                .toString()
                .replace(/_/g, ' ')
                .replace(/\w\S*/g, (word) => word.charAt(0).toUpperCase() + word.slice(1));
        }

        function setStatus(message, type = 'info', stage = '') {
            statusEl.innerHTML = '';
            statusEl.className = `status ${type}`;

            if (stage) {
                const badge = document.createElement('span');
                badge.className = 'stage-tag';
                badge.textContent = formatStageLabel(stage);
                statusEl.appendChild(badge);
            }

            const span = document.createElement('span');
            span.textContent = message;
            statusEl.appendChild(span);
            statusEl.classList.remove('hidden');
        }

        function clearStatus() {
            statusEl.innerHTML = '';
            statusEl.className = 'status hidden';
        }

        function toggleSubmitting(isSubmitting) {
            submitBtn.disabled = isSubmitting;
            submitBtn.textContent = isSubmitting ? 'Running...' : defaultSubmitLabel;
        }

        function toggleSeeding(isSeeding) {
            if (!seedBtn) return;
            seedBtn.disabled = isSeeding;
            seedBtn.textContent = isSeeding ? 'Seeding...' : defaultSeedLabel;
        }

        function clearResults() {
            sqlSection.classList.add('hidden');
            sqlOutput.textContent = '';
            metaSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            resultsWrapper.classList.add('hidden');
            resultsEmpty.textContent = 'Run a query to see results here.';
            resultsEmpty.classList.remove('hidden');
            resultsTable.querySelector('thead').innerHTML = '';
            resultsTable.querySelector('tbody').innerHTML = '';
        }

        function getCsrfToken() {
            const match = document.cookie.match(/csrftoken=([^;]+)/);
            return match ? decodeURIComponent(match[1]) : '';
        }

        function renderTable(columns = [], rows = []) {
            const thead = resultsTable.querySelector('thead');
            const tbody = resultsTable.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const hasColumns = Array.isArray(columns) && columns.length > 0;
            if (!hasColumns) {
                return false;
            }

            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            const normalizedRows = Array.isArray(rows) ? rows : [];
            normalizedRows.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = row[col];
                    td.textContent = value === null || value === undefined ? '' : value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            resultsWrapper.classList.remove('hidden');
            resultsEmpty.classList.add('hidden');
            return true;
        }

        function renderMetadata(metadata = {}, rows = []) {
            const safeMetadata = typeof metadata === 'object' && metadata !== null ? metadata : {};
            const rowCountFromMetadata = Number(safeMetadata.row_count);
            const rowCount = Number.isFinite(rowCountFromMetadata)
                ? rowCountFromMetadata
                : (Array.isArray(rows) ? rows.length : 0);

            const execution = Number(safeMetadata.execution_ms ?? safeMetadata.executionMs);
            const limit = Number(safeMetadata.max_rows ?? safeMetadata.maxRows);

            rowCountEl.textContent = rowCount.toLocaleString();
            executionTimeEl.textContent = Number.isFinite(execution) ? `${execution.toFixed(1)} ms` : '--';
            rowLimitEl.textContent = Number.isFinite(limit) ? limit.toLocaleString() : 'Default';

            if (rowCount === 0 && !Number.isFinite(execution) && !Number.isFinite(limit)) {
                metaSection.classList.add('hidden');
            } else {
                metaSection.classList.remove('hidden');
            }
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            clearStatus();
            clearResults();
            toggleSubmitting(true);
            setStatus('Running query...', 'info');

            const payload = {
                question: questionInput.value,
                language: languageSelect.value,
            };
            const maxRowsValue = maxRowsInput.value;
            if (maxRowsValue) {
                payload.max_rows = Number(maxRowsValue);
            }

            try {
                const response = await fetch('/api/query/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload),
                });

                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    setStatus('Received an invalid response from the server.', 'error');
                    return;
                }

                if (!data || typeof data !== 'object') {
                    setStatus('Unexpected server response.', 'error');
                    return;
                }

                if (!response.ok || data.status === 'error') {
                    setStatus(data.message || 'Request failed.', 'error', data.stage);
                    return;
                }

                setStatus('Query executed successfully.', 'success');
                if (data.sql) {
                    sqlOutput.textContent = data.sql;
                    sqlSection.classList.remove('hidden');
                }

                const hasResults = renderTable(data.columns, data.rows);
                if (hasResults) {
                    resultsSection.classList.remove('hidden');
                    resultsEmpty.classList.add('hidden');
                } else {
                    resultsSection.classList.remove('hidden');
                    resultsWrapper.classList.add('hidden');
                    resultsEmpty.textContent = 'No tabular data returned.';
                    resultsEmpty.classList.remove('hidden');
                }
                renderMetadata(data.metadata, data.rows);
            } catch (error) {
                console.error(error);
                setStatus('An unexpected error occurred.', 'error');
            } finally {
                toggleSubmitting(false);
            }
        });

        form.addEventListener('reset', () => {
            clearStatus();
            clearResults();
        });

        if (seedBtn) {
            seedBtn.addEventListener('click', async () => {
                clearStatus();
                setStatus('Seeding database...', 'info', 'seed');
                toggleSeeding(true);

                try {
                    const response = await fetch('/api/seed/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ purge: true }),
                    });

                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        setStatus('Seeding completed, but received an invalid response.', 'error', 'seed');
                        return;
                    }

                    if (!response.ok || data.status !== 'ok') {
                        setStatus(data?.message || 'Seeding failed.', 'error', data?.stage || 'seed');
                        return;
                    }

                    setStatus(data.message || 'Database seeded.', 'success', 'seed');
                } catch (error) {
                    console.error(error);
                    setStatus('Unable to seed database.', 'error', 'seed');
                } finally {
                    toggleSeeding(false);
                }
            });
        }
    </script>
</body>
</html>
